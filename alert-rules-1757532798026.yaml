apiVersion: 1
groups:
    - orgId: 1
      name: at least 1 min
      folder: Alerts
      interval: 1m
      rules:
        - uid: bexalo8uhj37kd
          title: Error Rate
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 3600
                to: 0
              datasourceUid: webstore-metrics
              model:
                adhocFilters: []
                datasource:
                    type: prometheus
                    uid: webstore-metrics
                editorMode: code
                expr: "sum by(service_name) ( \r\n  rate(traces_span_metrics_calls_total{status_code=\"STATUS_CODE_ERROR\"}[5m]) \r\n) "
                instant: true
                interval: ""
                intervalMs: 15000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: C
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 2
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: b1be6558-939d-4c43-a23f-f011d7d5c19a
          panelId: 8
          noDataState: NoData
          execErrState: Error
          for: 1m
          keepFiringFor: 1m
          annotations:
            __dashboardUid__: b1be6558-939d-4c43-a23f-f011d7d5c19a
            __panelId__: "8"
            runbook_url: https://request_error.example.com
            summary: Raising Error Rate Alert
          labels:
            type: http_request
          isPaused: false
          notification_settings:
            receiver: my-discord
        - uid: cexnkjjnwv6rka
          title: Pod CPU %
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 1800
                to: 0
              datasourceUid: webstore-metrics
              model:
                adhocFilters: []
                datasource:
                    type: prometheus
                    uid: webstore-metrics
                editorMode: code
                expr: "100 * sum(rate(container_cpu_usage_seconds_total{namespace=\"otel-demo\"}[5m])) by (pod) / 12 #total core\r\n"
                instant: true
                interval: ""
                intervalMs: 15000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: C
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 60
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: b1be6558-939d-4c43-a23f-f011d7d5c19a
          panelId: 2
          noDataState: NoData
          execErrState: Error
          for: 1m
          keepFiringFor: 1m
          annotations:
            __dashboardUid__: b1be6558-939d-4c43-a23f-f011d7d5c19a
            __panelId__: "2"
            runbook_url: high cpu alert action document!
            summary: high CPU alert
          isPaused: false
          notification_settings:
            receiver: my-discord
        - uid: cexnnyoipf3eod
          title: Pod Memory Usage (GB)
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 21600
                to: 0
              datasourceUid: webstore-metrics
              model:
                adhocFilters: []
                datasource:
                    type: prometheus
                    uid: webstore-metrics
                editorMode: code
                expr: "(\r\n  sum by(pod) (container_memory_working_set_bytes{namespace=\"otel-demo\", pod!=\"\"})\r\n  /\r\n  sum by(pod) (container_memory_working_set_bytes{namespace=\"otel-demo\", pod!=\"\"} offset 10m)\r\n) \r\n"
                instant: true
                interval: ""
                intervalMs: 15000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: C
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 10
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: b1be6558-939d-4c43-a23f-f011d7d5c19a
          panelId: 1
          noDataState: NoData
          execErrState: Error
          for: 1m
          annotations:
            __dashboardUid__: b1be6558-939d-4c43-a23f-f011d7d5c19a
            __panelId__: "1"
            summary: High Memory Usage
          isPaused: false
          notification_settings:
            receiver: my-discord
        - uid: cexnpa6l2g16oa
          title: Latency in ms
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 21600
                to: 0
              datasourceUid: webstore-metrics
              model:
                adhocFilters: []
                datasource:
                    type: prometheus
                    uid: webstore-metrics
                editorMode: code
                expr: "sum by (service_route) (\r\n  label_join(\r\n    label_replace(\r\n      rate(http_server_request_duration_seconds_sum{service_name=~\"(accounting|ad|cart|checkout|currency|email|flagd|fraud-detection|frontend|frontend-proxy|frontend-web|image-provider|load-generator|payment|product-catalog|quote|recommendation|shipping)\"}[5m]),\r\n      \"short_http_route\",\r\n      \"$1\",\r\n      \"http_route\",\r\n      \".*/([^/]+)$\"  #taking the last segment of http_route\r\n    ),\r\n    \"service_route\",\r\n    \"/\",\r\n    \"service_name\",\r\n    \"short_http_route\"\r\n  )\r\n) / sum by (service_route) (\r\n  label_join(\r\n    label_replace(\r\n      rate(http_server_request_duration_seconds_count[5m]),\r\n      \"short_http_route\",\r\n      \"$1\",\r\n      \"http_route\",\r\n      \".*/([^/]+)$\"\r\n    ),\r\n    \"service_route\",\r\n    \"/\",\r\n    \"service_name\",\r\n    \"short_http_route\"\r\n  )\r\n) * 100\r\n"
                instant: true
                interval: ""
                intervalMs: 15000
                legendFormat: __auto
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: C
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 1000
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: b1be6558-939d-4c43-a23f-f011d7d5c19a
          panelId: 5
          noDataState: NoData
          execErrState: Error
          for: 1m
          annotations:
            __dashboardUid__: b1be6558-939d-4c43-a23f-f011d7d5c19a
            __panelId__: "5"
            runbook_url: Documentation link for latency issues
            summary: Latency is higher than 1 second
          isPaused: false
          notification_settings:
            receiver: my-discord
        - uid: bexnpptbzxji8e
          title: Request Rate
          condition: C
          data:
            - refId: A
              relativeTimeRange:
                from: 10800
                to: 0
              datasourceUid: webstore-metrics
              model:
                adhocFilters: []
                datasource:
                    type: prometheus
                    uid: webstore-metrics
                editorMode: code
                expr: "(abs(\r\n  sum(rate(http_server_request_duration_seconds_count[5m])) by (service_name)\r\n  -\r\n  avg_over_time(sum(rate(http_server_request_duration_seconds_count[5m])) by (service_name)[1h:5m])\r\n)\r\n/\r\navg_over_time(sum(rate(http_server_request_duration_seconds_count[5m])) by (service_name)[1h:5m])\r\n)\r\n\r\n"
                instant: true
                interval: ""
                intervalMs: 15000
                legendFormat: '{{http_route}}'
                maxDataPoints: 43200
                range: false
                refId: A
            - refId: C
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0.5
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - C
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: A
                intervalMs: 1000
                maxDataPoints: 43200
                refId: C
                type: threshold
          dashboardUid: b1be6558-939d-4c43-a23f-f011d7d5c19a
          panelId: 4
          noDataState: NoData
          execErrState: Error
          for: 1m
          annotations:
            __dashboardUid__: b1be6558-939d-4c43-a23f-f011d7d5c19a
            __panelId__: "4"
            description: the request rate (5m) for a service changes by more than 50% compared to its average over the past hour
            summary: High New Request Rate
          isPaused: false
          notification_settings:
            receiver: my-discord
